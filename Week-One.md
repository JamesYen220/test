# Week One: Understanding basic compiler concepts, running ubuntu on qemu, understanding basic concepts of riscv hardware

**Compiler Concepts**
References: https://www.youtube.com/watch?v=F5-87RM_zHA&list=PL9pnk7GPwphF_PagGGUhpU1VzV7-j56vg&index=1&ab_channel=MITOpenCourseWare  
Interpretation and compilation:  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/77e4fbb8-1c77-4747-aec1-83ff293c5bfc">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/d158a822-40b7-4d4e-9d17-d01e53c4ba4e">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/a9ef1ea7-4b69-4a99-9ee1-8752f70c4687">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/ded658b8-1b68-4d73-9312-77ebafecca20">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/7483bf68-d3d4-4577-ae4c-991f64dfeeaf">  

Compiling expressions:  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/ae5b6e2d-db20-4318-ad15-e4d920b0434d">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/daac7442-e088-4b65-b852-7cc83adc439f">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/35997c26-323f-478f-a98a-161b532ec4ea">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/b394f377-fb69-402b-b73b-29e5ffc8ee26">  

Compiling statements:  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/dcf7ede2-8264-4059-be3a-f7f602568f55">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/12d4b020-6e69-4dd4-98cf-41d1190cbd57">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/3671d889-a448-495c-9f63-c29cc8686249">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/9e160d99-cd67-439e-8215-b825116c11cb">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/033bc649-3c8c-44b8-8d3f-14804063500b">  

Compiler frontend:  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/34d665ce-a681-41c3-a99a-72bf62d39779">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/9a7f1706-88d1-4889-ac19-2d9ed32a2d38">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/d1b42ab3-bfc6-428e-8d0f-ff14d3b72ae7">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/165d3eaf-260a-4f98-b569-816e163299d2">  


Optimization and Code Generation:  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/69c5ed93-353e-4f72-8507-c20548d2e605">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/185e430e-225b-49bc-a91c-88afd2be2366">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/2aa7c552-399b-4479-8567-f3a1d69bdd0c">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/8de905a9-1bb6-4419-a4ed-b5676cd41fbc">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/889c2d8b-e2bd-4e5d-83e6-415fc28db784">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/8f78517e-b6ca-474c-b01d-119ea5580b0c">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/03c847d1-a131-47bb-8814-c0b13181a27f">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/96d6531c-2b53-4b06-94f4-1b1ecef7a81b">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/e73ad76f-24be-4f50-a1a2-7b2ed238354b">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/93050c40-7417-4c51-8632-1910827744a1">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/a31e8009-a29e-4807-9c06-6eae9b690e8e">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/64f78843-dcd4-4fea-80dd-3d4e03d1ccfd">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/e50c9ebf-077b-4f65-b2ef-c67f3bbcefb6">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/a67fa80e-498e-4e83-a268-8e870e9f6797">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/d273e001-a049-42b0-a83d-1c1e9757f567">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/0d19dd93-97da-435d-9ba7-4a494e382801">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/897c571f-8a61-41f8-8f17-c193a68c8303">  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/e5bc52c8-c6b9-44dd-8a6f-02f35ebbb49e">  


**Understand Hardware**
Reference: https://doc.rvspace.org/VisionFive2/Quick_Start_Guide/VisionFive2_QSG/board_apperance.html  
The 组件介绍 (Component Introduction) section of the VisionFive2 RISC-V board lists various components and their descriptions:  
<img width="780" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/84aa4093-fb3b-404c-83c1-2ab06629ece7">  
1. 赛昉科技 昉·惊鸿7110 RISC-V 四核64位RV64GC ISA芯片平台 - This refers to the StarFive VisionFive 7110 RISC-V Quad-core 64-bit RV64GC ISA chip platform. It is the central processing unit based on the RISC-V instruction set architecture (ISA) and is 64-bit quad-core.
2. PoE Header - Power over Ethernet (PoE) Header. This is a header that can be used to supply electrical power and data over an Ethernet cable to the board.
3. 启动模式pin - Boot mode pin. It is a hardware pin used to select different boot options while powering on the board.
4. 40-Pin GPIO Header - 40-Pin General Purpose Input/Output (GPIO) Header. This is a set of 40 pins that can be used for various input and output operations like controlling LEDs, reading sensors, etc.
5. 2 GB/4 GB/8 GB LPDDR4 SDRAM - This refers to the Low Power Double Data Rate 4 (LPDDR4) Synchronous Dynamic Random-Access Memory (SDRAM) available in capacities of 2 GB, 4 GB, or 8 GB. It is used for temporary data storage and enables faster data access.
6. Reset键 - Reset button. It is used to restart or reset the board.  
7. EEPROM - Electrically Erasable Programmable Read-Only Memory. It is non-volatile memory used to store small amounts of data that must be saved when power is removed.  
8. USB-C接口，可用于供电和数据传输 - USB-C interface, which can be used for power supply and data transfer. It is a type of connector for universal serial bus (USB) that supports faster data transfer and can also provide power.  
9. 2-lane MIPI CSI - 2-lane Mobile Industry Processor Interface Camera Serial Interface. It is an interface for connecting cameras to the board.  
10. PMIC - Power Management Integrated Circuit. It is responsible for managing power requirements within the board.  
11. 2-Pin风扇接口 - 2-Pin fan connector. This is a connector for attaching a cooling fan to the board.  
12. GMAC0 PHY - Gigabit Media Access Control 0 PHYsical layer. It is part of the Ethernet interface and is responsible for the physical connection.  
13. GMAC1 PHY - Gigabit Media Access Control 1 PHYsical layer. Similar to GMAC0, it is another physical layer interface for Ethernet.  
14. 2 × 以太网接口（RJ45）- 2x Ethernet interfaces (RJ45). These are ports for connecting Ethernet cables for network communication.  
15. HDMI 2.0接口 - HDMI 2.0 interface. It is a digital interface used to transmit audio and video data.  
16. 3.5 mm音频插孔 - 3.5mm audio jack. It is a connector for audio devices such as headphones or speakers.  
17. 2 × USB 3.0接口 - 2x USB 3.0 interfaces. These are ports for connecting USB devices with support for faster data transfer compared to previous USB versions.  
18. 2 × USB 3.0接口 - (Same as 17) 2x USB 3.0 interfaces.  
19. 4-lane MIPI DSI - 4-lane Mobile Industry Processor  
20. USB 3.0主机控制器 - USB 3.0 host controller. This is a component that allows the board to interface with USB 3.0 devices, managing communication and data transfer.  
21. 2-lane MIPI DSI - 2-lane Mobile Industry Processor Interface Display Serial Interface. Similar to the 4-lane MIPI DSI, this is another interface for connecting display devices, but with fewer lanes.    
<img width="783" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/b7f0dd6b-ea53-4447-a9f5-fa9b916e8999">  

22. eMMC插槽 - eMMC slot. It is a slot for connecting embedded MultiMediaCards (eMMC), which are used for solid-state storage.   
23. TF卡插槽 - TF card slot. Also known as a MicroSD card slot, it is used for inserting microSD memory cards for storage.  
24. QSPI Flash - Quad Serial Peripheral Interface Flash. It is a type of non-volatile memory storage that allows the board to quickly read data with a serial interface.  
25. M.2 M-Key - M.2 slot with M-Key. It is a slot for connecting M.2 form factor devices, such as SSDs or other expansion cards.  

<img width="766" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/8f9a4d3c-16fa-4e2d-8b3c-3665a5b51273">  

1. The 40-Pin GPIO Header mentioned in the 组件介绍 section is what this pinout diagram is describing. It is a set of 40 pins that can be used for various input and output operations, and the diagram provides detailed information on how to use these pins.  
2. The mention of maximum safe current and total current for GPIO pins is important for safely operating and not damaging the board.  
3. The different functions that the GPIO pins can be configured for (SDIO, Audio, SPI, I2C, UART, and PWM) indicate the versatility of the board in interfacing with different kinds of peripherals and devices.  

**Running Ubuntu on Qemu**
References: https://www.arthurkoziel.com/qemu-ubuntu-20-04/  
https://nikosmouzakitis.medium.com/running-ubuntu-in-a-virtual-machine-on-qemu-quick-emulator-1607c10f4ba5  

Install qemu through homebrew:  
```shell
brew install qemu
``` 
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/5dd5dc20-527c-489a-a8b7-194400f06032">

1. **Installing ARM:**  
References: https://theboreddev.com/run-ubuntu-on-mac-using-qemu/
From the official site: https://ubuntu.com/download/server/arm  
Makefile:  
```
load:
	qemu-system-aarch64 \
    -machine virt,accel=hvf \
    -cpu max \
    -smp 2 \
    -hda ubuntu-23.04-live-server-arm64.qcow2 \
    -cdrom ./ubuntu-23.04-live-server-arm64.iso \
    -m 2G \
    -device virtio-gpu-pci \
    -device usb-ehci \
    -device usb-kbd \
    -device usb-mouse \
	-bios QEMU_EFI.fd \
    -display default,show-cursor=on

run:
	qemu-system-aarch64 \
	-monitor stdio \
	-M virt,highmem=off \
	-accel hvf \
	-cpu host \
	-smp 4 \
	-m 3000 \
	-bios QEMU_EFI.fd \
	-device virtio-gpu-pci \
	-display default,show-cursor=on \
	-device qemu-xhci \
	-device usb-kbd \
	-device usb-tablet \
	-device intel-hda \
	-device hda-duplex \
    -hda ubuntu-23.04-live-server-arm64.qcow2 \
```
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/a6336746-9011-47da-a97c-e1e1b4e605f6">


2. **Installing AMD (very slow running on m1 mac):**  
Install Ubutun and create the disk image:  
From the official site: https://ubuntu.com/download/desktop  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/c7d591ae-a885-4916-97d0-96687dfaf497">
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/d13badd8-3e4c-4197-a4e6-2fc7013125f4">

```shell
qemu-img create -f qcow2 ubuntu-23.04-desktop-amd64.qcow2 20G
```
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/f6b7a89e-8228-4bee-b57c-4ce1de636059">

Boot machine with Ubuntu ISO mounted:  
```shell
qemu-system-x86_64 \
    -machine type=q35 \
    -smp 2 \
    -hda ubuntu-23.04-desktop-amd64.qcow2 \
    -cdrom ./ubuntu-23.04-desktop-amd64.iso \
    -m 4G \
    -vga virtio \
    -usb \
    -device usb-tablet \
    -display default,show-cursor=on
```
This will pop up the screen:  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/bcdc0b54-84d5-4e0b-9f0e-e07dbdf76f18">
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/f5824b75-7572-4018-a4cb-4f11cd401c27">
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/6330fa76-dbbb-4997-9945-ed48529ae035">
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/d684fc99-c5fe-40d9-b7b8-5010dca99db3">  
After waiting some time:  
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/6495f6c8-bb23-47b8-aaae-5c5c654b4601">
<img width="800" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/153200fd-f91b-45d0-9777-f7a97828c6a0">

**Connecting SSH**
References: https://www.youtube.com/watch?v=Wlmne44M6fQ&ab_channel=KnowledgeSharingTech  
To set up SSH in QEMU Ubuntu, you need to perform several steps:

1. **Install SSH Server in the Ubuntu guest**: This can be done by running the command `sudo apt-get install openssh-server`.

2. **Configure the SSH Server**: The configuration file for the SSH server is located at `/etc/ssh/sshd_config`. You can edit this file to change the settings for the SSH server. For instance, you can change the port number on which the server listens (the default is 22), disable password-based authentication in favor of key-based authentication, and so on.

3. **Open a port for SSH in QEMU**: You need to forward a port from the host machine to the guest machine, so that when you connect to that port on the host machine, the connection is forwarded to the SSH port on the guest machine. This can be done by adding the `-net user,hostfwd=tcp::2222-:22` and `-net nic` options to the QEMU command line. The first option tells QEMU to forward connections to port 2222 on the host machine to port 22 on the guest machine. The second option tells QEMU to create a network interface card for the guest machine.

```
load:
	qemu-system-aarch64 \
    -machine virt,accel=hvf \
    -cpu max \
    -smp 2 \
    -hda ubuntu-23.04-live-server-arm64.qcow2 \
    -cdrom ./ubuntu-23.04-live-server-arm64.iso \
    -m 2G \
    -device virtio-gpu-pci \
    -device usb-ehci \
    -device usb-kbd \
    -device usb-mouse \
    -bios QEMU_EFI.fd \
    -display default,show-cursor=on \
    -net user,hostfwd=tcp::2222-:22 \
    -net nic

run:
	qemu-system-aarch64 \
    -monitor stdio \
    -M virt,highmem=off \
    -accel hvf \
    -cpu host \
    -smp 4 \
    -m 3000 \
    -bios QEMU_EFI.fd \
    -device virtio-gpu-pci \
    -display default,show-cursor=on \
    -device qemu-xhci \
    -device usb-kbd \
    -device usb-tablet \
    -device intel-hda \
    -device hda-duplex \
    -hda ubuntu-23.04-live-server-arm64.qcow2 \
    -net user,hostfwd=tcp::2222-:22 \
    -net nic
```

4. **Connect to the Ubuntu guest from the host**: Once the SSH server is set up and the port is forwarded, you can connect to the Ubuntu guest from the host machine by running the command `ssh james@localhost -p 2222`. You should replace `james` with your actual username on the Ubuntu guest, and `2222` with the actual port you forwarded on the host machine.

Please note that the `-net user,hostfwd=tcp::2222-:22` and `-net nic` options are added to the end of the `qemu-system-aarch64` command. Also, keep in mind that if you change the SSH port in the guest (in `/etc/ssh/sshd_config`), you should also change the `22` in the `-net user,hostfwd=tcp::2222-:22` option to match the new port.

<img width="604" alt="image" src="https://github.com/JamesYen220/RiscV-SummerTraining/assets/100248639/4902a40c-d48a-4bca-bd37-c7f610a56ac8">

Adding SSH (Secure Shell) to your QEMU Ubuntu can bring several benefits:

1. **Remote Access**: SSH allows you to access your virtual machine from the host machine, or even from another machine on the same network. This is useful if you need to run commands or transfer files to/from the virtual machine without using the QEMU console.

2. **Security**: SSH provides a secure, encrypted channel for communication, which can protect your data from being intercepted and read by unauthorized parties.

3. **Scripting and Automation**: With SSH, you can automate tasks on your virtual machine by writing scripts that run commands over SSH. This can save time and reduce the likelihood of errors compared to manually running commands.

4. **Tunneling**: SSH can be used to create secure tunnels for other network protocols. This can be useful for securing network traffic or bypassing network restrictions.

After you've executed the steps to set up SSH, you can confirm that everything is working correctly by attempting to connect to the SSH server on your QEMU Ubuntu from your host machine. You can do this with the command `ssh james@localhost -p 2222`, replacing `james` with your actual username on the Ubuntu guest, and `2222` with the actual port you forwarded on the host machine.

If the connection is successful, you'll be prompted for your password, and upon entering it, you'll be logged into your Ubuntu guest via SSH. This means that your SSH setup is correct. If the connection fails, check your network settings and the SSH server configuration in the Ubuntu guest.

Please note that if your SSH server is set up to use key-based authentication, you won't be prompted for a password. Instead, you'll need to provide the private key corresponding to the public key you added to the `~/.ssh/authorized_keys` file in your Ubuntu guest. You can do this with the `-i` option to the `ssh` command, like so: `ssh -i /path/to/private/key james@localhost -p 2222`.

